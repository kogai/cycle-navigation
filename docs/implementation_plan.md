# LilyGo T5S3-4.7-e-paper-PRO サイクルナビゲーション実装計画

## プロジェクト概要

LilyGo T5S3-4.7-e-paper-PRO を使用して、ロードバイク用の簡易ナビゲーションシステムを開発する。このシステムは主にマップ表示と現在地へのフォーカス機能を提供し、サイコン（サイクルコンピュータ）のように使用することを目的とする。

### 主な要件

- マップ表示と現在地表示に特化したシンプルな機能
- 長時間バッテリー駆動（48〜120 時間）
- グローブ着用時でも操作しやすい物理ボタンインターフェース
- 電子ペーパーディスプレイによる屋外での視認性確保

## ハードウェア構成

### 使用デバイス: LilyGo T5S3-4.7-e-paper-PRO

- **MCU**: ESP32-S3-WROOM-1 (16MB Flash / 8MB PSRAM)
- **ディスプレイ**: 4.7 インチ電子ペーパー (960x540, 16 階調グレースケール)
- **GPS**: MIA-M10Q
- **バッテリー**: 3.7V-1500mAh
- **バッテリー管理チップ**: BQ25896, BQ27220
- **その他**: SD カードスロット、物理ボタン

## 実装要素

### 1. 電源管理システム（優先度: 最高）

- **超低消費電力アーキテクチャ**

  - ESP32-S3 のディープスリープモードの活用
  - 必要最小限のコンポーネントのみ動作させる設計
  - GPS の間欠的な起動（位置更新は 1 分〜5 分間隔など、設定可能に）
  - 電子ペーパーディスプレイの特性を活かした消費電力最適化（更新時のみ電力消費）

- **バッテリー監視システム**

  - BQ27220 を使用したバッテリー残量の正確な測定
  - 残量に応じた動作モード切替（低バッテリー時は更新頻度を下げるなど）
  - バッテリー残量表示

- **電力消費最適化**
  - 不要なモジュール（LoRa、タッチスクリーンなど）の無効化
  - SD カードアクセスの最適化
  - 効率的な GPS 電力管理（NMEA 文の選択的処理など）

### 2. GPS システム

- **位置情報取得**

  - TinyGPS++ライブラリを使用した GPS データ処理
  - 緯度・経度、速度、高度、方位の取得
  - GPS 信号品質の監視

- **省電力 GPS 運用**
  - 間欠的な GPS 起動による電力節約
  - 移動速度に応じた更新頻度の動的調整
  - 停止検出による更新頻度低減

### 3. マップ表示システム

- **オフラインマップ管理**

  - SD カードに保存されたマップタイルの効率的な読み込み
  - 複数ズームレベルのサポート
  - マップデータの圧縮と効率的なストレージ利用

- **マップレンダリング**

  - epdiy ライブラリを使用した効率的な描画
  - グレースケール（16 階調）を活用した視認性の高いマップ表示
  - 部分更新機能による描画速度の最適化

- **現在地表示**
  - 現在位置のマーカー表示
  - 移動方向の表示
  - トラック（移動履歴）の表示オプション

### 4. ユーザーインターフェース

- **物理ボタン操作**

  - グローブ着用時でも操作しやすいボタン配置
  - 最小限のボタン数で効率的な操作を実現
  - ボタン機能の明確な割り当て（ズームイン/アウト、マップ移動、メニュー表示など）

- **シンプルな UI 設計**

  - 必要最小限の情報表示
  - 高コントラストで視認性の高いデザイン
  - 走行中でも一目で理解できる情報レイアウト

- **状態表示**
  - バッテリー残量
  - GPS 信号強度
  - 現在時刻
  - 基本的な走行データ（速度、走行距離など）

### 5. データ管理

- **マップデータ**

  - OpenStreetMap タイルの利用
  - 効率的なタイル保存形式の選定
  - 必要なマップ領域の事前ダウンロード機能

- **設定データ**
  - ユーザー設定の保存と読み込み
  - 走行履歴の記録（オプション）

## 実装フェーズ

### フェーズ 1: 基本システム構築

1. **開発環境セットアップ**

   - PlatformIO プロジェクト設定
   - 必要なライブラリのインストール

2. **ハードウェア初期化**

   - ESP32-S3 の初期化
   - 電子ペーパーディスプレイの初期化
   - GPS モジュールの初期化
   - 物理ボタンの設定

3. **電源管理基盤の実装**
   - バッテリー監視システムの実装
   - 省電力モードの基本設定
   - 不要なモジュールの無効化

### フェーズ 2: コア機能実装

1. **GPS 機能**

   - GPS 信号の取得と解析
   - 位置情報の処理
   - 省電力 GPS 動作の実装

2. **マップ表示の基本機能**

   - SD カードからのマップタイル読み込み
   - 基本的なマップ描画
   - 現在地表示の実装

3. **ユーザーインターフェース基盤**
   - 物理ボタンの入力処理
   - 基本的な UI 要素の実装
   - 状態表示の実装

### フェーズ 3: 機能拡張と最適化

1. **マップ機能の拡張**

   - 複数ズームレベルの対応
   - マップスクロール機能
   - トラック表示機能

2. **電力消費の最適化**

   - 動作モードの詳細調整
   - 更新頻度の最適化
   - バッテリー寿命テストと調整

3. **ユーザーインターフェースの改善**
   - 操作性の向上
   - 情報表示の最適化
   - エラー処理とリカバリー機能

### フェーズ 4: テストと完成

1. **実地テスト**

   - 実際のサイクリング環境でのテスト
   - バッテリー持続時間の検証
   - 使用感のフィードバック収集

2. **最終調整**

   - テスト結果に基づく調整
   - パフォーマンス最適化
   - 安定性向上

3. **ドキュメント作成**
   - 使用方法マニュアル
   - 技術仕様書
   - メンテナンス手順

## 技術的な検討事項

### 電力消費最適化

- **ディープスリープ戦略**

  - 短時間のディープスリープを繰り返す方式
  - 必要なコンポーネントのみをウェイクアップ
  - ULP（Ultra Low Power）コプロセッサの活用

- **データ処理の効率化**
  - メモリ使用の最適化
  - 計算負荷の軽減
  - 効率的なアルゴリズム選択

### マップデータ管理

- **タイル形式**

  - 標準的な OSM タイル形式（.png）
  - カスタム最適化形式（グレースケール専用）の検討
  - 圧縮形式の選定

- **キャッシュ戦略**
  - 頻繁に使用するタイルの RAM キャッシュ
  - 効率的な SD カードアクセス

### ユーザーエクスペリエンス

- **起動時間の最適化**

  - 素早く基本情報を表示
  - バックグラウンドでの詳細データ読み込み

- **操作性**
  - 最小限のボタン操作で主要機能にアクセス
  - 走行中の誤操作防止

## 次のステップ

1. 基本的なハードウェア制御コードの作成（ディスプレイ、GPS、ボタン）
2. 省電力アーキテクチャの設計と実装
3. シンプルなマップ表示システムのプロトタイプ開発
4. 実際のデバイスでのテストと評価
