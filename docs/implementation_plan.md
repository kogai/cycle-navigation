# サイクルナビゲーション実装計画

## 概要

LilyGo T5S3-4.7-e-paper-PRO を使用した、マップ表示と現在地へのフォーカスに特化した簡易ナビゲーションシステムの実装計画です。

## ハードウェア仕様

- **メインボード**: LilyGo T5S3-4.7-e-paper-PRO
  - **プロセッサ**: ESP32-S3
  - **ディスプレイ**: 4.7 インチ電子ペーパーディスプレイ
  - **GPS**: MIA-M10Q
  - **バッテリー管理**: BQ25896 + BQ27220
  - **IO 拡張**: PCA9535PW
  - **ストレージ**: microSD カード

## ソフトウェアアーキテクチャ

### コンポーネント構成

1. **電源管理 (PowerManager)**

   - バッテリー状態監視
   - 省電力モード制御
   - 周辺機器の電源制御

2. **GPS 管理 (GPSManager)**

   - 位置情報の取得と管理
   - 速度、方位などの情報処理
   - 省電力モード対応

3. **ディスプレイ管理 (DisplayManager)**

   - 電子ペーパーディスプレイの制御
   - マップ描画
   - UI 要素の描画

4. **入力管理 (InputManager)**

   - ボタン入力の処理
   - ユーザーインタラクション管理

5. **マップ管理 (MapManager)**
   - マップタイルの読み込み
   - 座標変換
   - ルート表示

### ファイル構成

```
src/cycle_navigation/
├── main.cpp              # メインアプリケーション
├── config.h              # 設定ファイル
├── power_manager.h       # 電源管理ヘッダ
├── power_manager.cpp     # 電源管理実装
├── gps_manager.h         # GPS管理ヘッダ
├── gps_manager.cpp       # GPS管理実装
├── display_manager.h     # ディスプレイ管理ヘッダ
├── display_manager.cpp   # ディスプレイ管理実装
└── ExtensionIOXL9555.hpp # IO拡張チップ制御
```

## 実装ステップ

### 1. 基本設定と初期化

- [x] プロジェクト構成の設定
- [x] 必要なライブラリの追加
- [x] 基本的な設定ファイル(config.h)の作成

### 2. 電源管理システム

- [x] PowerManager クラスの実装
- [x] バッテリー監視機能の実装
- [x] 省電力モードの実装
- [x] 周辺機器の電源制御機能の実装

### 3. GPS 機能

- [x] GPSManager クラスの実装
- [x] 位置情報取得機能の実装
- [x] 速度、方位などの情報処理の実装
- [x] GPS 省電力モードの実装

### 4. ディスプレイ制御

- [x] DisplayManager クラスの実装
- [x] 電子ペーパーディスプレイの初期化と制御
- [x] 基本的な描画機能の実装
- [x] マップ表示機能の実装
- [x] UI 要素（バッテリー残量、GPS 信号強度など）の表示機能の実装

### 5. マップ機能

- [ ] マップタイルの読み込み機能の実装
- [ ] 座標変換機能の実装
- [ ] マップのズーム・スクロール機能の実装
- [ ] 現在地表示機能の実装

### 6. ユーザーインターフェース

- [x] ボタン入力処理の実装
- [x] 基本的な UI 画面の実装
- [ ] 設定画面の実装
- [ ] ユーザー設定の保存機能の実装

### 7. 統合とテスト

- [x] 各コンポーネントの統合
- [ ] 基本機能のテスト
- [ ] 省電力モードのテスト
- [ ] 長時間動作テスト

## 機能一覧

### 基本機能

- [x] 現在地の表示
- [x] マップ表示
- [x] マップのズーム・スクロール
- [x] バッテリー残量表示
- [x] GPS 信号強度表示
- [x] 速度表示
- [x] 方位表示

### 拡張機能（優先度低）

- [ ] ルート表示
- [ ] ポイント登録
- [ ] トラック記録
- [ ] 高度表示
- [ ] 天気情報表示（要 LoRa 通信）

## 省電力戦略

1. **通常モード**

   - GPS: 5 秒ごとに更新
   - ディスプレイ: 30 秒ごとに更新
   - バッテリー監視: 60 秒ごとに更新

2. **低電力モード**

   - GPS: 55 秒スリープ、5 秒アクティブのサイクル
   - ディスプレイ: ユーザー操作時のみ更新
   - バッテリー監視: 120 秒ごとに更新

3. **緊急モード**（バッテリー残量 5%以下）
   - GPS: 無効
   - ディスプレイ: 最小限の更新
   - システム: 警告表示後、ディープスリープモードに移行

## 課題と対策

1. **電子ペーパーディスプレイの更新速度**

   - 部分更新を活用して、変更のある部分のみを更新
   - UI 要素とマップを分離して更新

2. **GPS の精度と電力消費**

   - 低電力モードでの GPS 動作最適化
   - 信号品質に応じた更新頻度の調整

3. **マップデータのストレージ**

   - オフラインマップタイルを SD カードに保存
   - 必要なタイルのみをメモリにロード

4. **バッテリー持続時間**
   - 未使用時の自動スリープモード
   - 周辺機器の電源管理の最適化

## 今後の展望

1. **マップデータ管理の改善**

   - より効率的なマップタイル管理
   - 圧縮マップタイルのサポート

2. **ユーザーインターフェースの拡張**

   - カスタマイズ可能な表示項目
   - より直感的な操作方法

3. **LoRa 通信機能の追加**

   - 他のデバイスとの通信
   - リアルタイム情報の共有

4. **センサー統合**
   - 気圧センサーによる高度表示
   - 温度センサーによる環境情報表示
